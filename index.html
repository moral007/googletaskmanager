<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Employee Task Management System</title>

  <!-- Font Awesome 6 -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    rel="stylesheet"/>

  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
    rel="stylesheet"/>

  <!-- Animate.css (for minor fade-in animations) -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    rel="stylesheet"/>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #2ec4b6;
      --success: #06d6a0;
      --danger: #ef476f;
      --warning: #ffd166;
      --info: #118ab2;
      --dark: #073b4c;
      --light: #f8f9fa;
      --body-bg: #f4f7fc;
      --card-bg: #ffffff;
      --sidebar-bg: #212529;
      --sidebar-hover: #2f3841;
      --sidebar-active: #3d4247;
      --text-dark: #212529;
      --text-light: #f8f9fa;
      --text-muted: #6c757d;
      --border-color: #e9ecef;
      --shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      --shadow-lg: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background-color: var(--body-bg);
      color: var(--text-dark);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Login Page Styles */
    #loginSection {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
      padding: 20px;
    }
    .login-container {
      width: 100%;
      max-width: 400px;
      overflow: hidden;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      background-color: var(--card-bg);
      animation: fadeInDown 0.8s;
    }
    .login-header {
      background-color: var(--primary);
      padding: 25px 20px;
      text-align: center;
    }
    .login-header h2 {
      color: white;
      margin: 0;
      font-weight: 600;
    }
    .login-logo {
      width: 80px;
      height: 80px;
      object-fit: contain;
      border-radius: 50%;
      padding: 10px;
      background-color: white;
      margin: 0 auto 15px;
      display: block;
    }
    .login-body {
      padding: 30px;
    }
    .form-floating {
      margin-bottom: 20px;
    }
    .form-floating input {
      border-radius: 8px;
      padding: 12px 15px;
      height: 55px;
      font-size: 16px;
      border: 1px solid var(--border-color);
    }
    .form-floating label {
      padding: 12px 15px;
      color: var(--text-muted);
    }
    .login-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px;
      font-size: 16px;
      font-weight: 500;
      width: 100%;
      margin-top: 10px;
      transition: var(--transition);
    }
    .login-btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    /* Main Layout Styles */
    .main-wrapper {
      display: flex;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* Sidebar Styles */
    .sidebar {
      width: 260px;
      height: 100vh;
      background-color: var(--sidebar-bg);
      position: fixed;
      top: 0;
      left: 0;
      z-index: 999;
      transition: var(--transition);
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
    }
    .sidebar-collapsed {
      transform: translateX(-260px);
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .sidebar-logo {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      margin-right: 10px;
    }
    .sidebar-title {
      color: white;
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    .sidebar-menu {
      padding: 15px 0;
    }
    .sidebar-item {
      position: relative;
    }
    .sidebar-link {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: var(--transition);
      font-size: 14px;
    }
    .sidebar-link:hover {
      background-color: var(--sidebar-hover);
      color: white;
    }
    .sidebar-item.active .sidebar-link {
      background-color: var(--sidebar-active);
      color: white;
      position: relative;
    }
    .sidebar-item.active .sidebar-link::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 4px;
      background-color: var(--warning);
    }
    .sidebar-icon {
      font-size: 16px;
      min-width: 24px;
      text-align: center;
      margin-right: 10px;
    }
    .sidebar-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 40px;
      height: 40px;
      background-color: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      z-index: 1001;
      box-shadow: var(--shadow);
      border: none;
      transition: var(--transition);
      display: none; /* hidden on desktops */
    }
    .sidebar-toggle:hover {
      background-color: var(--primary-dark);
    }

    /* Main Content Styles */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 20px;
      transition: var(--transition);
    }
    .main-content.expanded {
      margin-left: 0;
    }
    .content-header {
      margin-bottom: 25px;
    }
    .content-header h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--dark);
    }
    .content-header p {
      color: var(--text-muted);
      margin-bottom: 0;
    }
    .content-card {
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 25px;
      margin-bottom: 25px;
      animation: fadeIn 0.5s;
    }

    /* Summary Cards (Admin Stats) */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .summary-card {
      background-color: var(--card-bg);
      box-shadow: var(--shadow);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      color: var(--dark);
      animation: fadeIn 0.5s;
    }
    .summary-card h2 {
      font-size: 24px;
      margin-bottom: 5px;
      font-weight: 600;
    }
    .summary-card p {
      margin: 0;
      color: var(--text-muted);
    }

    /* Form Styles */
    .form-label {
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--dark);
    }
    .form-control,
    .form-select {
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      font-size: 14px;
      transition: var(--transition);
    }
    .form-control:focus,
    .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
    }
    .form-check-input {
      width: 18px;
      height: 18px;
      margin-top: 0.15em;
    }
    .form-check-label {
      font-size: 14px;
      padding-left: 5px;
    }

    /* Button Styles */
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 500;
      transition: var(--transition);
    }
    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
    }
    .btn-primary:hover {
      background-color: var(--primary-dark);
      border-color: var(--primary-dark);
      transform: translateY(-2px);
    }
    .btn-success {
      background-color: var(--success);
      border-color: var(--success);
    }
    .btn-success:hover {
      background-color: #05c090;
      border-color: #05c090;
      transform: translateY(-2px);
    }
    .btn-danger {
      background-color: var(--danger);
      border-color: var(--danger);
    }
    .btn-danger:hover {
      background-color: #e43464;
      border-color: #e43464;
      transform: translateY(-2px);
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    /* Table Styles */
    .table {
      width: 100%;
      margin-bottom: 0;
      color: var(--text-dark);
      vertical-align: middle;
      border-color: var(--border-color);
    }
    .table thead th {
      background-color: rgba(67, 97, 238, 0.1);
      font-weight: 600;
      border-bottom: none;
      padding: 12px 15px;
      color: var(--dark);
      font-size: 14px;
    }
    .table tbody td {
      padding: 12px 15px;
      vertical-align: middle;
      font-size: 14px;
    }
    .table-striped tbody tr:nth-of-type(odd) {
      background-color: rgba(0, 0, 0, 0.02);
    }
    .table-hover tbody tr:hover {
      background-color: rgba(67, 97, 238, 0.05);
    }

    /* Priority & Duration/Days Styles */
    .priority-yes {
      color: var(--danger);
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    .priority-no {
      color: var(--success);
      display: flex;
      align-items: center;
    }
    .priority-yes::before,
    .priority-no::before {
      content: "";
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }
    .priority-yes::before {
      background-color: var(--danger);
    }
    .priority-no::before {
      background-color: var(--success);
    }

    /* Status Labeling */
    .status-pending {
      color: #fd7e14; /* orange for pending */
      font-weight: 600;
    }
    .status-completed {
      color: #06d6a0; /* green for completed */
      font-weight: 600;
    }

    /* Toast Notification Styles */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }
    .custom-toast {
      max-width: 350px;
      overflow: hidden;
      font-size: 0.875rem;
      background-color: var(--card-bg);
      background-clip: padding-box;
      border: none;
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(10px);
      border-radius: 10px;
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
      transform: translateX(100%);
    }
    .custom-toast.showing {
      opacity: 1;
      transform: translateX(0);
    }
    .custom-toast.show {
      opacity: 1;
      transform: translateX(0);
    }
    .custom-toast.hide {
      opacity: 0;
      transform: translateX(100%);
    }
    .toast-header {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      color: var(--text-dark);
      background-color: rgba(255, 255, 255, 0.85);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    .toast-body {
      padding: 1rem;
    }
    .toast-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      margin-right: 10px;
      color: white;
    }
    .toast-icon.success {
      background-color: var(--success);
    }
    .toast-icon.error {
      background-color: var(--danger);
    }
    .toast-icon.warning {
      background-color: var(--warning);
    }
    .toast-icon.info {
      background-color: var(--info);
    }

    /* Responsiveness */
    @media (max-width: 991.98px) {
      .sidebar {
        transform: translateX(-260px);
      }
      .main-content {
        margin-left: 0;
      }
      .sidebar-toggle {
        display: flex;
      }
      .sidebar.show {
        transform: translateX(0);
      }
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translate3d(0, -20px, 0);
      }
      to {
        opacity: 1;
        transform: translate3d(0, 0, 0);
      }
    }

    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 80px;
      height: 80px;
      position: fixed;
      top: 50%;
      left: 50%;
      margin-top: -40px;
      margin-left: -40px;
      z-index: 2000;
      display: none;
    }
    .loading-spinner:after {
      content: " ";
      display: block;
      width: 64px;
      height: 64px;
      margin: 8px;
      border-radius: 50%;
      border: 6px solid var(--primary);
      border-color: var(--primary) transparent var(--primary) transparent;
      animation: spinner 1.2s linear infinite;
    }
    @keyframes spinner {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
      z-index: 1999;
      display: none;
    }
  </style>
</head>

<body>
  <!-- Loading Spinner -->
  <div class="loading-spinner" id="loadingSpinner"></div>
  <div class="overlay" id="overlay"></div>

  <!-- Toast Container (for notifications) -->
  <div class="toast-container"></div>

  <!-- Toggle Button for Sidebar (visible on smaller screens) -->
  <button class="sidebar-toggle" id="sidebarToggle">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Login Section -->
  <div id="loginSection">
    <div class="login-container">
      <div class="login-header">
        <img
          src="https://cdn.bio.link/uploads/profile_pictures/2025-03-06/jOi36H0WMovo35xDjdVDqaaBZEk7g0xl.png"
          alt="Logo"
          class="login-logo"
        />
        <h2>Task Management</h2>
      </div>
      <div class="login-body">
        <form id="loginForm" onsubmit="return handleLogin()">
          <div class="form-floating mb-3">
            <input type="text" class="form-control" id="email" placeholder="Email" required />

            <label for="username">Email</label>
          </div>
          <div class="form-floating mb-3">
            <input
              type="password"
              class="form-control"
              id="password"
              placeholder="Password"
              required
            />
            <label for="password">Password</label>
          </div>
          <button type="submit" class="login-btn">
            <i class="fas fa-sign-in-alt me-2"></i> Log In
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Main App Section -->
  <div id="mainSection" style="display:none;">
    <div class="main-wrapper">
      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <img
            src="https://cdn.bio.link/uploads/profile_pictures/2023-06-15/etVNEktTBAHeqr3VCEzEkgYUuPMSmigA.png"
            alt="Logo"
            class="sidebar-logo"
          />
          <h5 class="sidebar-title">Task Management</h5>
        </div>
        <div class="sidebar-menu">
          <ul class="nav flex-column" id="sidebarMenu">
            <li class="sidebar-item active" data-target="dashboard">
              <a href="#" class="sidebar-link">
                <i class="fas fa-th-large sidebar-icon"></i>
                <span>Task Overview</span>
              </a>
            </li>
            <li class="sidebar-item" data-target="incomplete">
              <a href="#" class="sidebar-link">
                <i class="fas fa-clock sidebar-icon"></i>
                <span>Incomplete Tasks</span>
              </a>
            </li>
            <li class="sidebar-item" data-target="createTask">
              <a href="#" class="sidebar-link">
                <i class="fas fa-plus-circle sidebar-icon"></i>
                <span>Create New Task</span>
              </a>
            </li>
            <li class="sidebar-item" data-target="updateTask">
              <a href="#" class="sidebar-link">
                <i class="fas fa-edit sidebar-icon"></i>
                <span>Update Task</span>
              </a>
            </li>
            <!-- Admin Only Menu Items -->
            <li class="sidebar-item adminOnly" data-target="adminTasks" style="display: none;">
              <a href="#" class="sidebar-link">
                <i class="fas fa-list sidebar-icon"></i>
                <span>Manage All Tasks</span>
              </a>
            </li>
            <!-- We rename "Admin Create Task" --> 
            <li class="sidebar-item adminOnly" data-target="adminCreateTask" style="display: none;">
              <a href="#" class="sidebar-link">
                <i class="fas fa-user-plus sidebar-icon"></i>
                <span>Create New Task</span>
              </a>
            </li>
            <li class="sidebar-item adminOnly" data-target="adminUpdateTask" style="display: none;">
              <a href="#" class="sidebar-link">
                <i class="fas fa-user-edit sidebar-icon"></i>
                <span>Admin Update Task</span>
              </a>
            </li>
            <li class="sidebar-item" data-target="logout">
              <a href="#" class="sidebar-link" onclick="logoutApp()">
                <i class="fas fa-sign-out-alt sidebar-icon"></i>
                <span>Logout</span>
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="main-content" id="mainContent">
        <!-- Hidden field to store the logged-in user's email -->
        <input type="hidden" id="loggedInUser" />

        <!-- Dashboard Page -->
        <div id="dashboard" class="content-container active" style="display:block;">
          <div class="content-header">
            <h1>Task Overview</h1>
            <p>Monitor and manage your tasks efficiently.</p>
          </div>
          <div class="content-card">
            <!-- User Dashboard (Completed) -->
            <div id="userDashboard" style="display:none;">
              <h3 class="mb-4">Completed Tasks</h3>
              <div class="table-responsive">
                <table class="table table-striped table-hover">
                  <thead>
                    <tr>
                      <th>Task</th>
                      <th>Start Date</th>
                      <th>End Date</th>
                      <th>Duration</th>
                      <th>Priority</th>
                    </tr>
                  </thead>
                  <tbody id="completedTasksTable"></tbody>
                </table>
              </div>
            </div>

            <!-- Admin Dashboard (All Employees' Completed Tasks) -->
            <div id="adminDashboard" style="display:none;">
              <h3 class="mb-4">All Employees' Completed Tasks</h3>

              <!-- Search & Date Range Filters -->
              <div class="row g-2 mb-3">
                <div class="col-md-3">
                  <input
                    type="text"
                    class="form-control"
                    id="adminCompletedSearch"
                    placeholder="Search by employee/task..."
                    oninput="filterAdminCompletedTasks()"
                  />
                </div>
                <div class="col-md-3">
                  <input
                    type="date"
                    class="form-control"
                    id="adminCompletedStartDate"
                    onchange="filterAdminCompletedTasks()"
                    placeholder="Start date filter"
                  />
                </div>
                <div class="col-md-3">
                  <input
                    type="date"
                    class="form-control"
                    id="adminCompletedEndDate"
                    onchange="filterAdminCompletedTasks()"
                    placeholder="End date filter"
                  />
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-striped table-hover">
                  <thead>
                    <tr>
                      <th>Employee</th>
                      <th>Task</th>
                      <th>Start Date</th>
                      <th>End Date</th>
                      <th>Duration</th>
                      <th>Priority</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="adminCompletedTasksTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Incomplete Tasks Page (User) -->
        <div id="incomplete" class="content-container" style="display:none;">
          <div class="content-header">
            <h1>Incomplete Tasks</h1>
            <p>View your tasks that are currently in progress.</p>
          </div>
          <div class="content-card">
            <!-- Search & Date Range Filters for Incomplete -->
            <div class="row g-2 mb-3">
              <div class="col-md-4">
                <input
                  type="text"
                  class="form-control"
                  id="incompleteSearch"
                  placeholder="Search by task..."
                  oninput="filterIncompleteTasks()"
                />
              </div>
              <div class="col-md-4">
                <input
                  type="date"
                  class="form-control"
                  id="incompleteStartDate"
                  onchange="filterIncompleteTasks()"
                  placeholder="Filter by Start Date"
                />
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Task</th>
                    <th>Start Date</th>
                    <th>Days</th>
                    <th>Priority</th>
                  </tr>
                </thead>
                <tbody id="incompleteTasksTable"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Create Task Page (User) -->
        <div id="createTask" class="content-container" style="display:none;">
          <div class="content-header">
            <h1>Create New Task</h1>
            <p>Assign new tasks and track their progress from start to finish.</p>
          </div>
          <div class="content-card">
            <form onsubmit="return submitNewTask()">
              <div class="mb-3">
                <label for="taskDetails" class="form-label">Task Details:</label>
                <input
                  type="text"
                  class="form-control"
                  id="taskDetails"
                  required
                  placeholder="Enter task details"
                />
              </div>
              <div class="mb-3">
                <label for="startTime" class="form-label">Start Date:</label>
                <input
                  type="date"
                  class="form-control"
                  id="startTime"
                  required
                />
              </div>
              <div class="mb-3 form-check">
                <input
                  type="checkbox"
                  class="form-check-input"
                  id="isPriority"
                />
                <label class="form-check-label" for="isPriority">
                  Set as Priority
                </label>
              </div>
              <button type="submit" class="btn btn-success">
                <i class="fas fa-save me-2"></i> Save Task
              </button>
            </form>
          </div>
        </div>

        <!-- Update Task Page (User completes tasks) -->
        <div id="updateTask" class="content-container" style="display:none;">
          <div class="content-header">
            <h1>Update Task</h1>
            <p>Finalize tasks by marking them as completed.</p>
          </div>
          <div class="content-card">
            <form onsubmit="return submitEndTime()">
              <div class="mb-3">
                <label for="taskDropdown" class="form-label">Select Task:</label>
                <select class="form-select" id="taskDropdown" required></select>
              </div>
              <div class="mb-3">
                <label for="endTime" class="form-label">End Date:</label>
                <input
                  type="date"
                  class="form-control"
                  id="endTime"
                  required
                />
              </div>
              <button type="submit" class="btn btn-success">
                <i class="fas fa-check-circle me-2"></i> Mark Task as Completed
              </button>
            </form>
          </div>
        </div>

        <!-- Admin Manage All Tasks Page -->
        <div id="adminTasks" class="content-container" style="display:none;">
          <div class="content-header">
            <h1>All Employees' Tasks</h1>
            <p>View and manage all employees' tasks.</p>
          </div>

          <!-- Summary Cards (Stats) -->
          <div class="summary-cards">
            <div class="summary-card">
              <h2 id="allTasksCount">0</h2>
              <p>All Tasks</p>
            </div>
            <div class="summary-card">
              <h2 id="completedTasksCount">0</h2>
              <p>Completed</p>
            </div>
            <div class="summary-card">
              <h2 id="pendingTasksCount">0</h2>
              <p>Pending</p>
            </div>
            <div class="summary-card">
              <h2 id="priorityTasksCount">0</h2>
              <p>Priority Tasks</p>
            </div>
            <div class="summary-card">
              <h2 id="nonPriorityTasksCount">0</h2>
              <p>Non-Priority</p>
            </div>
          </div>

          <div class="content-card">
            <!-- Filters row -->
            <div class="row g-2 mb-3">
              <div class="col-md-3">
                <input
                  type="text"
                  class="form-control"
                  id="allTasksSearch"
                  placeholder="Search by username/task..."
                  oninput="filterAllTasks()"
                />
              </div>
              <div class="col-md-3">
                <input
                  type="date"
                  class="form-control"
                  id="allTasksStartDate"
                  onchange="filterAllTasks()"
                />
              </div>
              <div class="col-md-3">
                <input
                  type="date"
                  class="form-control"
                  id="allTasksEndDate"
                  onchange="filterAllTasks()"
                />
              </div>
              <div class="col-md-3 d-flex">
                <select
                  class="form-select me-2"
                  id="allTasksPriorityFilter"
                  onchange="filterAllTasks()"
                >
                  <option value="">Priority?</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
                <select
                  class="form-select"
                  id="allTasksStatusFilter"
                  onchange="filterAllTasks()"
                >
                  <option value="">Status?</option>
                  <option value="Pending">Pending</option>
                  <option value="Completed">Completed</option>
                </select>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Employee</th>
                    <th>Task</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Duration</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="allTasksTable"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Admin Create Task Page -->
        <div id="adminCreateTask" class="content-container" style="display:none;">
          <div class="content-header">
            <h1>Create New Task for Employee</h1>
            <p>Assign a new task to a specific employee.</p>
          </div>
          <div class="content-card">
            <form onsubmit="return adminSubmitNewTask()">
              <div class="mb-3">
                <label for="adminTaskUsername" class="form-label"
                  >Select Employee:</label
                >
                <select class="form-select" id="adminTaskUsername" required>
                </select>
              </div>
              <div class="mb-3">
                <label for="adminTaskDetails" class="form-label"
                  >Task Details:</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="adminTaskDetails"
                  required
                  placeholder="Enter task details"
                />
              </div>
              <div class="mb-3">
                <label for="adminStartTime" class="form-label">Start Date:</label>
                <input
                  type="date"
                  class="form-control"
                  id="adminStartTime"
                  required
                />
              </div>
              <div class="mb-3 form-check">
                <input
                  type="checkbox"
                  class="form-check-input"
                  id="adminIsPriority"
                />
                <label class="form-check-label" for="adminIsPriority"
                  >Set as Priority</label
                >
              </div>
              <button type="submit" class="btn btn-success">
                <i class="fas fa-save me-2"></i> Save Task
              </button>
            </form>
          </div>
        </div>

        <!-- Admin Update Task Page -->
        <div id="adminUpdateTask" class="content-container" style="display:none;">
          <div class="content-header">
            <h1>Update Employee's Task</h1>
            <p>Finalize a task for a specific employee by marking it as completed.</p>
          </div>
          <div class="content-card">
            <form onsubmit="return adminSubmitEndTime()">
              <div class="mb-3">
                <label for="adminSelectUsername" class="form-label"
                  >Select Employee:</label
                >
                <select
                  class="form-select"
                  id="adminSelectUsername"
                  required
                  onchange="loadAdminTasksForUser(this.value)"
                ></select>
              </div>
              <div class="mb-3">
                <label for="adminTaskDropdown" class="form-label"
                  >Select Task:</label
                >
                <select class="form-select" id="adminTaskDropdown" required></select>
              </div>
              <div class="mb-3">
                <label for="adminEndTime" class="form-label">End Date:</label>
                <input
                  type="date"
                  class="form-control"
                  id="adminEndTime"
                  required
                />
              </div>
              <div class="mb-3 form-check">
                <input
                  type="checkbox"
                  class="form-check-input"
                  id="adminIsPriorityUpdate"
                />
                <label class="form-check-label" for="adminIsPriorityUpdate"
                  >Set as Priority</label
                >
              </div>
              <button type="submit" class="btn btn-success">
                <i class="fas fa-check-circle me-2"></i> Mark Task as Completed
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL FOR EDITING A TASK (ADMIN) -->
  <div
    class="modal fade"
    id="editTaskModal"
    tabindex="-1"
    aria-labelledby="editTaskModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editTaskForm" onsubmit="return saveTaskEdits()">
          <div class="modal-header">
            <h5 class="modal-title" id="editTaskModalLabel">Edit Task</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editRowNumber" />
            <div class="mb-3">
              <label for="editTaskDetails" class="form-label">Task Details:</label>
              <input
                type="text"
                class="form-control"
                id="editTaskDetails"
                required
              />
            </div>
            <div class="mb-3">
              <label for="editStartDate" class="form-label">Start Date:</label>
              <input
                type="date"
                class="form-control"
                id="editStartDate"
                required
              />
            </div>
            <div class="mb-3">
              <label for="editEndDate" class="form-label">End Date:</label>
              <input
                type="date"
                class="form-control"
                id="editEndDate"
              />
            </div>
            <div class="mb-3 form-check">
              <input
                type="checkbox"
                class="form-check-input"
                id="editIsPriority"
              />
              <label class="form-check-label" for="editIsPriority"
                >Set as Priority</label
              >
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-2"></i> Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

  <script>
    // ------------------------------------
    // GLOBAL VARIABLES
    // ------------------------------------
    let currentRole = 'user'; 
    let adminCompletedTasks = []; // for admin's completed tasks
    let incompleteTasksData = []; // user incomplete tasks
    let allTasksData = []; // for "Manage All Tasks" (admin)
    let editingModal = null; // reference to the modal

    // ------------------------------------
    // TOAST NOTIFICATION SYSTEM
    // ------------------------------------
    function showToast(title, message, type = 'success') {
      const toastContainer = document.querySelector('.toast-container');
      const toastId = 'toast-' + Date.now();
      const iconClass =
        type === 'success'
          ? 'fas fa-check-circle'
          : type === 'error'
          ? 'fas fa-times-circle'
          : type === 'warning'
          ? 'fas fa-exclamation-triangle'
          : 'fas fa-info-circle';

      const toastHTML = `
        <div id="${toastId}" class="custom-toast">
          <div class="toast-header">
            <div class="toast-icon ${type}">
              <i class="${iconClass}"></i>
            </div>
            <strong class="me-auto">${title}</strong>
            <small>Just now</small>
            <button type="button" class="btn-close" onclick="closeToast('${toastId}')"></button>
          </div>
          <div class="toast-body">
            ${message}
          </div>
        </div>
      `;
      toastContainer.insertAdjacentHTML('beforeend', toastHTML);
      const toast = document.getElementById(toastId);

      // Trigger initial animation
      setTimeout(() => {
        toast.classList.add('showing');
      }, 10);

      setTimeout(() => {
        toast.classList.remove('showing');
        toast.classList.add('show');
      }, 300);

      // Auto close after 5 seconds
      setTimeout(() => {
        closeToast(toastId);
      }, 5000);
    }

    function closeToast(toastId) {
      const toast = document.getElementById(toastId);
      if (toast) {
        toast.classList.add('hide');
        setTimeout(() => {
          toast.remove();
        }, 300);
      }
    }

    // ------------------------------------
    // LOADING SPINNER
    // ------------------------------------
    function showLoading() {
      document.getElementById('loadingSpinner').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    }
    function hideLoading() {
      document.getElementById('loadingSpinner').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }

    // ------------------------------------
    // SIDEBAR & INITIALIZATION
    // ------------------------------------
    document.addEventListener('DOMContentLoaded', function() {
      // Set today's date as default for relevant date fields
      const today = new Date().toISOString().split('T')[0];
      [
        'startTime','endTime','adminStartTime','adminEndTime',
        'editStartDate','editEndDate'
      ].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.value = today;
      });

      // Setup the Bootstrap modal reference
      editingModal = new bootstrap.Modal(document.getElementById('editTaskModal'), {
        keyboard: false
      });

      // Sidebar toggle (mobile)
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebar = document.getElementById('sidebar');
      sidebarToggle.addEventListener('click', function() {
        sidebar.classList.toggle('show');
      });

      // Handle sidebar menu clicks
      const sidebarItems = document.querySelectorAll('.sidebar-item');
      const contentContainers = document.querySelectorAll('.content-container');
      sidebarItems.forEach(item => {
        item.addEventListener('click', function() {
          const target = this.getAttribute('data-target');

          // Remove active class from all sidebar items
          sidebarItems.forEach(menuItem => menuItem.classList.remove('active'));
          this.classList.add('active');

          // Hide all content containers
          contentContainers.forEach(container => {
            container.classList.remove('active');
            container.style.display = 'none';
          });

          // Show the selected container
          const selectedContainer = document.getElementById(target);
          if (selectedContainer) {
            selectedContainer.style.display = 'block';
            setTimeout(() => {
              selectedContainer.classList.add('active');
            }, 10);
          }

          // Close sidebar on mobile
          if (window.innerWidth <= 991.98) {
            sidebar.classList.remove('show');
          }

          // Page-specific refresh logic
          if (target === 'dashboard') {
            if (currentRole === 'admin') {
              refreshAdminCompletedTasks();
            } else {
              const username = document.getElementById('loggedInUser').value;
              if (username) {
                refreshCompletedTasks(username);
              }
            }
          } else if (target === 'incomplete') {
            const username = document.getElementById('loggedInUser').value;
            loadIncompleteTasks(username);
          } else if (target === 'adminTasks') {
            loadAllTasks();
          } else if (target === 'adminUpdateTask') {
            populateAdminSelectUsername();
          }
        });
      });

      // Handle window resize
      window.addEventListener('resize', function() {
        if (window.innerWidth > 991.98) {
          sidebar.classList.remove('show');
        }
      });
    });

    // ------------------------------------
    // LOGIN
    // ------------------------------------
    function handleLogin() {
      showLoading();
      const username = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      google.script.run.withSuccessHandler(function(response) {
        hideLoading();
        if (response.isValid) {
          currentRole = response.role;
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('mainSection').style.display = 'block';

          // Store the logged-in userâ€™s email
          document.getElementById('loggedInUser').value = username;

          if (currentRole === 'admin') {
            // Admin
            document.getElementById('userDashboard').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            showAdminOnlyElements(true);

            // Load all tasks + user dropdowns
            loadAllTasks();
            populateAdminUserDropdowns();

            // Completed tasks for admin dashboard
            adminCompletedTasks = response.tasks.slice();
            renderAdminCompletedTasks(adminCompletedTasks);

            showToast('Welcome Admin', 'You have successfully logged in as Administrator');
          } else {
            // Normal user
            document.getElementById('userDashboard').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            showAdminOnlyElements(false);

            // Show user completed tasks
            renderUserCompletedTasks(response.tasks);
            // Load incomplete tasks for user
            loadIncompleteTasks(username);
            // Prepare update dropdown
            loadExistingTasks(username);

            // If there are new tasks, show a notification
            if (response.newTasksCount && response.newTasksCount > 0) {
              showToast('New Tasks', `You have ${response.newTasksCount} new pending task(s)!`, 'info');
            } else {
              showToast('Welcome', 'You have successfully logged in');
            }
          }
        } else {
          showToast('Login Failed', 'Invalid username or password', 'error');
        }
      }).validateLogin(username, password);

      return false;
    }

    function showAdminOnlyElements(show) {
      const adminElements = document.querySelectorAll('.adminOnly');
      adminElements.forEach(elem => {
        elem.style.display = show ? 'block' : 'none';
      });
    }

    function clearMainSection() {
      // Clear tables
      document.getElementById('completedTasksTable').innerHTML = '';
      document.getElementById('incompleteTasksTable').innerHTML = '';
      document.getElementById('adminCompletedTasksTable').innerHTML = '';

      // Clear forms
      const dateStr = new Date().toISOString().split('T')[0];
      [
        'taskDetails','startTime','adminTaskDetails','adminStartTime',
        'allTasksSearch','allTasksStartDate','allTasksEndDate'
      ].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.value = '';
      });
      ['isPriority','adminIsPriority','adminIsPriorityUpdate'].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.checked = false;
      });
      ['taskDropdown','adminTaskDropdown'].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.innerHTML = '';
      });
      document.getElementById('endTime').value = dateStr;

      // Hide user or admin dashboard
      document.getElementById('userDashboard').style.display = 'none';
      document.getElementById('adminDashboard').style.display = 'none';
    }

    function logoutApp() {
      showLoading();
      setTimeout(() => {
        hideLoading();
        document.getElementById('mainSection').style.display = 'none';
        document.getElementById('loginSection').style.display = 'flex';
        showToast('Logged Out', 'You have been logged out successfully');
        clearMainSection();
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
      }, 800);
    }

    // ------------------------------------
    // USER TASK FUNCTIONS
    // ------------------------------------
    function submitNewTask() {
      showLoading();
      // The creator & assignee are the same if it's a normal user
      const creatorEmail = document.getElementById('loggedInUser').value; 
      const username = creatorEmail;  // For a normal user, they assign tasks to themselves
      const taskDetails = document.getElementById('taskDetails').value;
      const startDate = document.getElementById('startTime').value;
      const isPriority = document.getElementById('isPriority').checked;

      google.script.run.withSuccessHandler(function() {
        hideLoading();
        showToast('Task Created', 'Your task has been saved & email notification sent');
        // Refresh user tasks
        loadExistingTasks(username);
        loadIncompleteTasks(username);
        refreshCompletedTasks(username);
        // Reset form
        document.getElementById('taskDetails').value = '';
        document.getElementById('startTime').value = new Date().toISOString().split('T')[0];
        document.getElementById('isPriority').checked = false;
      }).saveNewTask(username, taskDetails, startDate, isPriority, creatorEmail);

      return false;
    }

    function loadExistingTasks(username) {
      showLoading();
      google.script.run.withSuccessHandler(function(tasks) {
        hideLoading();
        const taskDropdown = document.getElementById('taskDropdown');
        taskDropdown.innerHTML = '';
        if (!tasks || tasks.length === 0) {
          const option = document.createElement('option');
          option.value = '';
          option.text = 'No tasks available';
          taskDropdown.appendChild(option);
        } else {
          tasks.forEach(function(task) {
            const option = document.createElement('option');
            option.value = task.task;
            option.text = `${task.task} (${task.priority})`;
            taskDropdown.appendChild(option);
          });
        }
      }).getExistingTasks(username);
    }

    function submitEndTime() {
      showLoading();
      const taskDetails = document.getElementById('taskDropdown').value;
      const endDate = document.getElementById('endTime').value;
      const username = document.getElementById('loggedInUser').value;

      google.script.run.withSuccessHandler(function() {
        hideLoading();
        showToast('Task Completed', 'The task has been marked as completed');
        loadExistingTasks(username);
        loadIncompleteTasks(username);
        refreshCompletedTasks(username);
        document.getElementById('endTime').value = new Date().toISOString().split('T')[0];
      }).saveEndTime(taskDetails, endDate);

      return false;
    }

    function loadIncompleteTasks(username) {
      showLoading();
      google.script.run.withSuccessHandler(function(tasks) {
        hideLoading();
        incompleteTasksData = tasks.slice();
        renderIncompleteTasks(incompleteTasksData);
      }).getIncompleteTasks(username);
    }

    function renderIncompleteTasks(taskArray) {
      const tableBody = document.getElementById('incompleteTasksTable');
      tableBody.innerHTML = '';
      if (!taskArray || taskArray.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="4" class="text-center">No incomplete tasks found</td>';
        tableBody.appendChild(row);
      } else {
        taskArray.forEach(function(task) {
          const dayCount = parseInt(task.days, 10) || 0;
          const dayButton = (dayCount === 0)
            ? `<button class="btn btn-sm btn-danger">0 days</button>`
            : `<button class="btn btn-sm btn-success">${dayCount} days</button>`;

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${task.task}</td>
            <td>${task.startDate}</td>
            <td>${dayButton}</td>
            <td class="${task.priority.toLowerCase() === 'yes' ? 'priority-yes' : 'priority-no'}">
              ${task.priority}
            </td>
          `;
          tableBody.appendChild(row);
        });
      }
    }

    function refreshCompletedTasks(username) {
      showLoading();
      google.script.run.withSuccessHandler(function(tasks) {
        hideLoading();
        renderUserCompletedTasks(tasks);
      }).getCompletedTasks(username);
    }

    function renderUserCompletedTasks(tasks) {
      const tableBody = document.getElementById('completedTasksTable');
      tableBody.innerHTML = '';
      if (!tasks || tasks.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="5" class="text-center">No completed tasks found</td>';
        tableBody.appendChild(row);
      } else {
        tasks.forEach(function(task) {
          const durationStr = task.duration || '0 days';
          const durNumber = parseInt(durationStr, 10) || 0;
          const durButton = (durNumber === 0)
            ? `<button class="btn btn-sm btn-danger">${durationStr}</button>`
            : `<button class="btn btn-sm btn-success">${durationStr}</button>`;

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${task.task}</td>
            <td>${task.startDate}</td>
            <td>${task.endDate}</td>
            <td>${durButton}</td>
            <td class="${task.priority.toLowerCase() === 'yes' ? 'priority-yes' : 'priority-no'}">${task.priority}</td>
          `;
          tableBody.appendChild(row);
        });
      }
    }

    function filterIncompleteTasks() {
      const searchInput = document.getElementById('incompleteSearch').value.toLowerCase().trim();
      const startFilter = document.getElementById('incompleteStartDate').value;
      const filtered = incompleteTasksData.filter(task => {
        let matchText = true;
        let matchStart = true;
        if (searchInput) {
          matchText = task.task.toLowerCase().includes(searchInput);
        }
        if (startFilter) {
          if (task.startDate < startFilter) matchStart = false;
        }
        return matchText && matchStart;
      });
      renderIncompleteTasks(filtered);
    }

    // ------------------------------------
    // ADMIN FUNCTIONS
    // ------------------------------------
    function loadAllTasks() {
      showLoading();
      google.script.run.withSuccessHandler(function(tasks) {
        hideLoading();
        allTasksData = tasks.slice();
        renderAllTasks(allTasksData);
        renderTaskStats(allTasksData);
      }).getAllTasks();
    }

    function renderAllTasks(taskArray) {
      const tableBody = document.getElementById('allTasksTable');
      tableBody.innerHTML = '';

      if (!taskArray || taskArray.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="8" class="text-center">No tasks found</td>';
        tableBody.appendChild(row);
      } else {
        taskArray.forEach(function(task) {
          const durStr = task.duration || '0 days';
          const durNum = parseInt(durStr, 10) || 0;
          const durButton = (durNum === 0)
            ? `<button class="btn btn-sm btn-danger">${durStr}</button>`
            : `<button class="btn btn-sm btn-success">${durStr}</button>`;

          const priorityClass = (task.priority.toLowerCase() === 'yes') ? 'priority-yes' : 'priority-no';
          const statusClass = (task.status.toLowerCase() === 'pending') ? 'status-pending' : 'status-completed';

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${task.username}</td>
            <td>${task.task}</td>
            <td>${task.startDate || '-'}</td>
            <td>${task.endDate || '-'}</td>
            <td>${durButton}</td>
            <td class="${priorityClass}">${task.priority}</td>
            <td class="${statusClass}">${task.status}</td>
            <td>
              <button class="btn btn-sm btn-primary me-1"
                onclick="openEditModal(${task.rowNumber}, '${escapeQuotes(task.task)}', '${task.startDate}', '${task.endDate}', '${task.priority}')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteTask(${task.rowNumber})">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      }
    }

    function renderTaskStats(tasks) {
      let allCount = tasks.length;
      let completedCount = tasks.filter(t => t.status === 'Completed').length;
      let pendingCount = tasks.filter(t => t.status === 'Pending').length;
      let priorityCount = tasks.filter(t => t.priority.toLowerCase() === 'yes').length;
      let nonPriorityCount = tasks.filter(t => t.priority.toLowerCase() === 'no').length;

      document.getElementById('allTasksCount').innerText = allCount;
      document.getElementById('completedTasksCount').innerText = completedCount;
      document.getElementById('pendingTasksCount').innerText = pendingCount;
      document.getElementById('priorityTasksCount').innerText = priorityCount;
      document.getElementById('nonPriorityTasksCount').innerText = nonPriorityCount;
    }

    function filterAllTasks() {
      const searchText = document.getElementById('allTasksSearch').value.toLowerCase().trim();
      const startDate = document.getElementById('allTasksStartDate').value;
      const endDate = document.getElementById('allTasksEndDate').value;
      const priorityFilter = document.getElementById('allTasksPriorityFilter').value;
      const statusFilter = document.getElementById('allTasksStatusFilter').value;

      const filtered = allTasksData.filter(task => {
        let matchSearch = true;
        let matchStart = true;
        let matchEnd = true;
        let matchPriority = true;
        let matchStatus = true;

        if (searchText) {
          const combined = (task.username + ' ' + task.task).toLowerCase();
          if (!combined.includes(searchText)) matchSearch = false;
        }
        if (startDate && task.startDate) {
          if (task.startDate < startDate) matchStart = false;
        }
        if (endDate && task.startDate) {
          if (task.startDate > endDate) matchEnd = false;
        }
        if (priorityFilter) {
          if (task.priority !== priorityFilter) matchPriority = false;
        }
        if (statusFilter) {
          if (task.status !== statusFilter) matchStatus = false;
        }

        return matchSearch && matchStart && matchEnd && matchPriority && matchStatus;
      });

      renderAllTasks(filtered);
      renderTaskStats(filtered);
    }

    function escapeQuotes(str) {
      return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }

    function populateAdminUserDropdowns() {
      showLoading();
      google.script.run.withSuccessHandler(function(users) {
        hideLoading();
        const adminTaskUsername = document.getElementById('adminTaskUsername');
        const adminSelectUsername = document.getElementById('adminSelectUsername');

        adminTaskUsername.innerHTML = '';
        adminSelectUsername.innerHTML = '<option value="">Select Employee</option>';

        if (!users || users.length === 0) {
          const option1 = document.createElement('option');
          option1.value = '';
          option1.text = 'No users available';
          adminTaskUsername.appendChild(option1);

          const option2 = document.createElement('option');
          option2.value = '';
          option2.text = 'No users available';
          adminSelectUsername.appendChild(option2);
        } else {
          users.forEach(function(user) {
            // Only list non-admin users for new tasks
            if (user.role.toLowerCase() !== 'admin') {
              const option1 = document.createElement('option');
              option1.value = user.username; // email
              option1.text = user.username;
              adminTaskUsername.appendChild(option1);

              const option2 = document.createElement('option');
              option2.value = user.username;
              option2.text = user.username;
              adminSelectUsername.appendChild(option2);
            }
          });
        }
      }).getAllUsers();
    }

    function adminSubmitNewTask() {
      showLoading();
      const creatorEmail = document.getElementById('loggedInUser').value; // The admin's email
      const username = document.getElementById('adminTaskUsername').value; // The employee's email
      const taskDetails = document.getElementById('adminTaskDetails').value;
      const startDate = document.getElementById('adminStartTime').value;
      const isPriority = document.getElementById('adminIsPriority').checked;

      google.script.run.withSuccessHandler(function() {
        hideLoading();
        showToast('Task Assigned', 'A new task was assigned & email sent to ' + username);
        loadAllTasks();

        // Reset
        document.getElementById('adminTaskDetails').value = '';
        document.getElementById('adminStartTime').value = new Date().toISOString().split('T')[0];
        document.getElementById('adminIsPriority').checked = false;
      }).saveNewTask(username, taskDetails, startDate, isPriority, creatorEmail);

      return false;
    }

    function populateAdminSelectUsername() {
      populateAdminUserDropdowns();
    }

    function loadAdminTasksForUser(username) {
      if (!username) return;
      showLoading();
      google.script.run.withSuccessHandler(function(tasks) {
        hideLoading();
        const taskDropdown = document.getElementById('adminTaskDropdown');
        taskDropdown.innerHTML = '';
        if (!tasks || tasks.length === 0) {
          const option = document.createElement('option');
          option.value = '';
          option.text = 'No tasks available';
          taskDropdown.appendChild(option);
        } else {
          tasks.forEach(function(task) {
            const option = document.createElement('option');
            option.value = task.rowNumber;
            option.text = `${task.task} (${task.priority})`;
            taskDropdown.appendChild(option);
          });
        }
      }).getExistingTasks(username);
    }

    function adminSubmitEndTime() {
      showLoading();
      const taskDetailsRowNumber = document.getElementById('adminTaskDropdown').value;
      const endDate = document.getElementById('adminEndTime').value;
      const username = document.getElementById('adminSelectUsername').value;
      const isPriority = document.getElementById('adminIsPriorityUpdate').checked;

      google.script.run.withSuccessHandler(function(response) {
        hideLoading();
        if (response.success) {
          showToast('Task Updated', 'The task has been marked as completed');
          loadAllTasks();
          loadAdminTasksForUser(username);

          // Reset
          document.getElementById('adminEndTime').value = new Date().toISOString().split('T')[0];
          document.getElementById('adminIsPriorityUpdate').checked = false;
        } else {
          showToast('Error', 'Failed to update task', 'error');
        }
      }).saveEndTimeByRow(taskDetailsRowNumber, endDate, isPriority);

      return false;
    }

    // ------------------------------------
    // ADMIN COMPLETED TASKS (OVERVIEW)
    // ------------------------------------
    function refreshAdminCompletedTasks() {
      showLoading();
      google.script.run.withSuccessHandler(function(tasks) {
        hideLoading();
        // Filter only completed tasks
        adminCompletedTasks = tasks.filter(function(t) {
          return t.status === 'Completed';
        });
        renderAdminCompletedTasks(adminCompletedTasks);
      }).getAllTasks();
    }

    function renderAdminCompletedTasks(tasksArr) {
      const tableBody = document.getElementById('adminCompletedTasksTable');
      tableBody.innerHTML = '';

      if (!tasksArr || tasksArr.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="7" class="text-center">No completed tasks found</td>';
        tableBody.appendChild(row);
      } else {
        tasksArr.forEach(function(task) {
          const durStr = task.duration || '0 days';
          const durNum = parseInt(durStr, 10) || 0;
          const durButton = (durNum === 0)
            ? `<button class="btn btn-sm btn-danger">${durStr}</button>`
            : `<button class="btn btn-sm btn-success">${durStr}</button>`;

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${task.username}</td>
            <td>${task.task}</td>
            <td>${task.startDate}</td>
            <td>${task.endDate}</td>
            <td>${durButton}</td>
            <td class="${task.priority.toLowerCase() === 'yes' ? 'priority-yes' : 'priority-no'}">${task.priority}</td>
            <td>
              <button class="btn btn-sm btn-primary me-1"
                onclick="openEditModal(${task.rowNumber}, '${escapeQuotes(task.task)}', '${task.startDate}', '${task.endDate}', '${task.priority}')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteTask(${task.rowNumber})">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      }
    }

    function filterAdminCompletedTasks() {
      const searchText = document.getElementById('adminCompletedSearch').value.toLowerCase().trim();
      const startFilter = document.getElementById('adminCompletedStartDate').value;
      const endFilter = document.getElementById('adminCompletedEndDate').value;

      const filtered = adminCompletedTasks.filter(task => {
        let matchText = true;
        let matchDateRange = true;

        if (searchText) {
          const combined = (task.username + ' ' + task.task).toLowerCase();
          if (!combined.includes(searchText)) matchText = false;
        }
        if (startFilter && task.startDate < startFilter) matchDateRange = false;
        if (endFilter && task.startDate > endFilter) matchDateRange = false;

        return matchText && matchDateRange;
      });
      renderAdminCompletedTasks(filtered);
    }

    // ------------------------------------
    // EDIT TASK (OPEN MODAL)
    // ------------------------------------
    function openEditModal(rowNumber, taskDetails, startDate, endDate, priority) {
      document.getElementById('editRowNumber').value = rowNumber;
      document.getElementById('editTaskDetails').value = taskDetails || '';
      document.getElementById('editStartDate').value = startDate || '';
      document.getElementById('editEndDate').value = endDate || '';
      document.getElementById('editIsPriority').checked = (priority.toLowerCase() === 'yes');

      editingModal.show();
    }

    // SAVE TASK EDITS
    function saveTaskEdits() {
      showLoading();
      const rowNumber = document.getElementById('editRowNumber').value;
      const newTaskDetails = document.getElementById('editTaskDetails').value;
      const newStartDate = document.getElementById('editStartDate').value;
      const newEndDate = document.getElementById('editEndDate').value;
      const newPriority = document.getElementById('editIsPriority').checked ? 'Yes' : 'No';

      google.script.run.withSuccessHandler(function(resp) {
        hideLoading();
        if (resp.success) {
          showToast('Task Updated', 'Task changes have been saved successfully');
          editingModal.hide();
          // Refresh relevant tables
          loadAllTasks();
          refreshAdminCompletedTasks();
        } else {
          showToast('Error', 'Failed to update the task', 'error');
        }
      }).editTask(rowNumber, newTaskDetails, newStartDate, newEndDate, newPriority);

      return false;
    }

    // DELETE TASK
    function deleteTask(rowNumber) {
      const doDelete = confirm('Are you sure you want to delete this task?');
      if (!doDelete) return;

      showLoading();
      google.script.run.withSuccessHandler(function(resp) {
        hideLoading();
        if (resp.success) {
          showToast('Task Deleted', 'Task has been deleted successfully');
          loadAllTasks();
          refreshAdminCompletedTasks();
        } else {
          showToast('Error', 'Failed to delete the task', 'error');
        }
      }).deleteTask(rowNumber);
    }
  </script>

<!-- âœ… Full Updated index.html -->
<!-- âœ… Integrated original layout with Milestones & Messages modal functionality -->

<!-- Hidden Logged-in User -->
<input type="hidden" id="loggedInUser" value="user1@example.com" />

<!-- ðŸ”„ Place this "Details" button where task rows are rendered (for both users/admin) -->
<!-- <button class="btn btn-outline-primary btn-sm" onclick="openTaskDetailModal(ROW_NUMBER, 'TASK_NAME')">Details</button> -->

<!-- ðŸªŸ Task Detail Modal -->
<div class="modal fade" id="taskDetailModal" tabindex="-1" aria-labelledby="taskDetailLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="taskDetailLabel">Task Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Tabs: Milestones | Messages -->
        <ul class="nav nav-tabs mb-3" id="taskTabs">
          <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#milestoneTab">Milestones</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#messagesTab">Messages</a>
          </li>
        </ul>

        <div class="tab-content">
          <!-- Milestone Tab -->
          <div class="tab-pane fade show active" id="milestoneTab">
            <div class="d-flex mb-2">
              <input type="text" class="form-control me-2" id="milestoneName" placeholder="Milestone name" />
              <input type="date" class="form-control me-2" id="milestoneTarget" />
              <button class="btn btn-success" onclick="handleAddMilestone()">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <ul class="list-group" id="milestoneList"></ul>
          </div>

          <!-- Messages Tab -->
          <div class="tab-pane fade" id="messagesTab">
            <div class="border rounded p-3 mb-2" style="height: 300px; overflow-y: auto;" id="taskMessageThread"></div>
            <div class="input-group">
              <input type="text" class="form-control" placeholder="Write a message..." id="taskMessageInput" />
              <button class="btn btn-primary" onclick="handleSendMessage()">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>

        <input type="hidden" id="detailTaskRow" />
        <input type="hidden" id="detailTaskName" />
      </div>
    </div>
  </div>
</div>

<!-- JS Functions -->
<script>
  function openTaskDetailModal(row, name) {
    document.getElementById('detailTaskRow').value = row;
    document.getElementById('detailTaskName').value = name;
    document.getElementById('milestoneName').value = '';
    document.getElementById('taskMessageInput').value = '';
    loadMilestones(row);
    loadMessages(row);
    const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
    modal.show();
  }

  function loadMilestones(taskRow) {
    google.script.run.withSuccessHandler(function(data) {
      const list = document.getElementById('milestoneList');
      list.innerHTML = '';
      if (!data.length) {
        list.innerHTML = '<li class="list-group-item">No milestones yet</li>';
        return;
      }
      data.forEach(m => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          <span>
            <strong>${m.milestone}</strong> <br/>
            <small>Target: ${m.targetDate} | Status: ${m.status}</small>
          </span>
          ${m.status === 'Pending' ? `<button class='btn btn-sm btn-success' onclick="markMilestoneComplete('${taskRow}', '${m.milestone}')">Mark Done</button>` : `<span class='badge bg-success'>Done</span>`}
        `;
        list.appendChild(li);
      });
    }).getMilestones(taskRow);
  }

  function handleAddMilestone() {
    const row = document.getElementById('detailTaskRow').value;
    const name = document.getElementById('milestoneName').value.trim();
    const target = document.getElementById('milestoneTarget').value;
    if (!name || !target) return alert('Milestone name and date required');
    google.script.run.withSuccessHandler(() => {
      loadMilestones(row);
      document.getElementById('milestoneName').value = '';
      document.getElementById('milestoneTarget').value = '';
    }).addMilestone(row, name, target);
  }

  function markMilestoneComplete(row, name) {
    const today = new Date().toISOString().split('T')[0];
    google.script.run.withSuccessHandler(() => loadMilestones(row))
      .markMilestoneComplete(row, name, today);
  }

  function loadMessages(taskRow) {
    google.script.run.withSuccessHandler(function(messages) {
      const thread = document.getElementById('taskMessageThread');
      thread.innerHTML = '';
      messages.forEach(m => {
        const div = document.createElement('div');
        div.className = 'mb-2';
        div.innerHTML = `
          <div><strong>${m.author}</strong> <span class="text-muted small">[${m.timestamp}]</span></div>
          <div>${m.message}</div>
        `;
        thread.appendChild(div);
      });
    }).getTaskMessages(taskRow);
  }

  function handleSendMessage() {
    const row = document.getElementById('detailTaskRow').value;
    const author = document.getElementById('loggedInUser').value;
    const msg = document.getElementById('taskMessageInput').value.trim();
    if (!msg) return;
    google.script.run.withSuccessHandler(() => {
      document.getElementById('taskMessageInput').value = '';
      loadMessages(row);
    }).addTaskMessage(row, msg, author);
  }
</script>
</body>
</html>
